-- Update ALL remaining treatments with realistic costs from tratamientos_realizados
UPDATE tratamientos_completados SET total_original = 700.00, total_descuento = 0.00, total_final = 700.00, actualizado_en = NOW() WHERE id = '9efec68d-6624-4f2f-9912-d0af9ad6c997';
UPDATE tratamientos_completados SET total_original = 1.00, total_descuento = 0.00, total_final = 1.00, actualizado_en = NOW() WHERE id = '9a600466-bbc8-4e06-9fc2-8d618a9a42c7';
UPDATE tratamientos_completados SET total_original = 1.00, total_descuento = 0.00, total_final = 1.00, actualizado_en = NOW() WHERE id = 'b5a41a37-ec7d-4a72-8ae6-c6045fb9403c';
UPDATE tratamientos_completados SET total_original = 700.00, total_descuento = 0.00, total_final = 700.00, actualizado_en = NOW() WHERE id = '1a62843f-b6af-46cd-afd8-b475bcd2e4a3';
UPDATE tratamientos_completados SET total_original = 700.00, total_descuento = 0.00, total_final = 700.00, actualizado_en = NOW() WHERE id = 'd0b3f7cc-9c0e-48c9-aa08-39bb84efe593';
UPDATE tratamientos_completados SET total_original = 700.00, total_descuento = 0.00, total_final = 700.00, actualizado_en = NOW() WHERE id = '413e087a-b6a2-4487-845e-d7371b9ec953';
UPDATE tratamientos_completados SET total_original = 700.00, total_descuento = 0.00, total_final = 700.00, actualizado_en = NOW() WHERE id = '375611c4-6906-4949-8d26-686a2198aaf8';
UPDATE tratamientos_completados SET total_original = 700.00, total_descuento = 0.00, total_final = 700.00, actualizado_en = NOW() WHERE id = 'f0425bf7-2fd8-4148-b599-dc508719b9c7';
UPDATE tratamientos_completados SET total_original = 700.00, total_descuento = 0.00, total_final = 700.00, actualizado_en = NOW() WHERE id = 'bd25f71a-53b7-44f8-a438-13d32671ff3e';
UPDATE tratamientos_completados SET total_original = 700.00, total_descuento = 0.00, total_final = 700.00, actualizado_en = NOW() WHERE id = '82713ce6-c8f4-4b75-9b35-659c4d1fd3c6';
UPDATE tratamientos_completados SET total_original = 700.00, total_descuento = 0.00, total_final = 700.00, actualizado_en = NOW() WHERE id = '33446798-29e2-4d6d-bb98-91d517718ffd';
UPDATE tratamientos_completados SET total_original = 700.00, total_descuento = 0.00, total_final = 700.00, actualizado_en = NOW() WHERE id = '64ceaa18-82ce-4b82-8b8c-9eb8357df49a';
UPDATE tratamientos_completados SET total_original = 3500.00, total_descuento = 0.00, total_final = 3500.00, actualizado_en = NOW() WHERE id = 'b5a41a37-ec7d-4a72-8ae6-c6045fb9403c';
UPDATE tratamientos_completados SET total_original = 1400.00, total_descuento = 0.00, total_final = 1400.00, actualizado_en = NOW() WHERE id = 'ee83bdcb-e1f1-4519-bc15-2fd1263bbab6';
UPDATE tratamientos_completados SET total_original = 1400.00, total_descuento = 0.00, total_final = 1400.00, actualizado_en = NOW() WHERE id = '707ba767-2bd9-4fbd-a38e-95f46695e2ec';
UPDATE tratamientos_completados SET total_original = 1400.00, total_descuento = 0.00, total_final = 1400.00, actualizado_en = NOW() WHERE id = 'bf3910b5-fb16-4376-9b69-a439d3cf211b';
UPDATE tratamientos_completados SET total_original = 700.00, total_descuento = 0.00, total_final = 700.00, actualizado_en = NOW() WHERE id = '08649e7e-f9ea-4f69-9bc7-2e1bdf9ef702';
UPDATE tratamientos_completados SET total_original = 2800.00, total_descuento = 0.00, total_final = 2800.00, actualizado_en = NOW() WHERE id = '61f96367-bfa6-47aa-af59-2a491efcca68';
UPDATE tratamientos_completados SET total_original = 2800.00, total_descuento = 0.00, total_final = 2800.00, actualizado_en = NOW() WHERE id = '8707bb50-6d2e-4784-a7ff-cfafe3c5cd09';
UPDATE tratamientos_completados SET total_original = 700.00, total_descuento = 0.00, total_final = 700.00, actualizado_en = NOW() WHERE id = '48986ee6-5c61-4904-bac3-ac0017557b5f';
UPDATE tratamientos_completados SET total_original = 1000.00, total_descuento = 0.00, total_final = 1000.00, actualizado_en = NOW() WHERE id = '31e57bc5-4b46-49d7-84c1-843ec7673c7d';
UPDATE tratamientos_completados SET total_original = 1000.00, total_descuento = 0.00, total_final = 1000.00, actualizado_en = NOW() WHERE id = '7963c1d9-0495-46e5-abf7-1c880ba35c17';
UPDATE tratamientos_completados SET total_original = 1000.00, total_descuento = 0.00, total_final = 1000.00, actualizado_en = NOW() WHERE id = 'c958fd01-818b-4d73-a184-6b56cf81d5cc';
UPDATE tratamientos_completados SET total_original = 1100.00, total_descuento = 0.00, total_final = 1100.00, actualizado_en = NOW() WHERE id = '31488fae-bc4c-45a3-8a9b-8df46e7c414a';
UPDATE tratamientos_completados SET total_original = 1200.00, total_descuento = 0.00, total_final = 1200.00, actualizado_en = NOW() WHERE id = '5c2f0df5-ccc4-4ae9-a392-3b744b5635c1';
UPDATE tratamientos_completados SET total_original = 1200.00, total_descuento = 0.00, total_final = 1200.00, actualizado_en = NOW() WHERE id = '94d582d6-7e7f-4309-9d88-4066bcc7cb94';
UPDATE tratamientos_completados SET total_original = 1200.00, total_descuento = 0.00, total_final = 1200.00, actualizado_en = NOW() WHERE id = 'f2464fba-5223-470e-8020-0803e6efa5c8';
UPDATE tratamientos_completados SET total_original = 1200.00, total_descuento = 0.00, total_final = 1200.00, actualizado_en = NOW() WHERE id = 'a843c260-a492-4745-8a26-22d7c84552da';
UPDATE tratamientos_completados SET total_original = 1200.00, total_descuento = 0.00, total_final = 1200.00, actualizado_en = NOW() WHERE id = '357b9956-9e87-476e-b533-17a18494e319';
UPDATE tratamientos_completados SET total_original = 1200.00, total_descuento = 0.00, total_final = 1200.00, actualizado_en = NOW() WHERE id = '25d154bf-2b99-4493-981a-33edaae06376';
UPDATE tratamientos_completados SET total_original = 1200.00, total_descuento = 0.00, total_final = 1200.00, actualizado_en = NOW() WHERE id = 'dd94c53d-b751-470b-bf68-335cd047d753';
UPDATE tratamientos_completados SET total_original = 1200.00, total_descuento = 0.00, total_final = 1200.00, actualizado_en = NOW() WHERE id = '8c1dceba-a420-4cbd-bb3a-961c8f6f8d94';
UPDATE tratamientos_completados SET total_original = 1200.00, total_descuento = 0.00, total_final = 1200.00, actualizado_en = NOW() WHERE id = 'dc1edb2a-e62c-42ec-9c0e-3edab26a5728';
UPDATE tratamientos_completados SET total_original = 1300.00, total_descuento = 0.00, total_final = 1300.00, actualizado_en = NOW() WHERE id = '45d0bd32-5b6e-4cf9-aca8-3c274e3b662d';
UPDATE tratamientos_completados SET total_original = 1300.00, total_descuento = 0.00, total_final = 1300.00, actualizado_en = NOW() WHERE id = '1b4408a6-2910-43c5-93a1-4c35321a15b0';
UPDATE tratamientos_completados SET total_original = 1600.00, total_descuento = 0.00, total_final = 1600.00, actualizado_en = NOW() WHERE id = 'ce0bbc39-6551-46f0-aaf7-01e5d8201258';
UPDATE tratamientos_completados SET total_original = 1600.00, total_descuento = 0.00, total_final = 1600.00, actualizado_en = NOW() WHERE id = '413e087a-b6a2-4487-845e-d7371b9ec953';
UPDATE tratamientos_completados SET total_original = 3200.00, total_descuento = 0.00, total_final = 3200.00, actualizado_en = NOW() WHERE id = 'c301e784-996c-464c-a452-fcb96fcf6f37';
UPDATE tratamientos_completados SET total_original = 1600.00, total_descuento = 0.00, total_final = 1600.00, actualizado_en = NOW() WHERE id = 'be021d86-6cc7-464c-ac48-ea8a7084b2d2';
UPDATE tratamientos_completados SET total_original = 2100.00, total_descuento = 0.00, total_final = 2100.00, actualizado_en = NOW() WHERE id = '102e7c3f-6e40-4d17-ab60-1d47b37f7b31';
UPDATE tratamientos_completados SET total_original = 2600.00, total_descuento = 0.00, total_final = 2600.00, actualizado_en = NOW() WHERE id = 'c301e784-996c-464c-a452-fcb96fcf6f37';
UPDATE tratamientos_completados SET total_original = 2600.00, total_descuento = 0.00, total_final = 2600.00, actualizado_en = NOW() WHERE id = '413e087a-b6a2-4487-845e-d7371b9ec953';
UPDATE tratamientos_completados SET total_original = 2800.00, total_descuento = 0.00, total_final = 2800.00, actualizado_en = NOW() WHERE id = 'dc1edb2a-e62c-42ec-9c0e-3edab26a5728';
UPDATE tratamientos_completados SET total_original = 2800.00, total_descuento = 0.00, total_final = 2800.00, actualizado_en = NOW() WHERE id = '0f63c2ed-fa8c-48ea-9f59-42727b9b7f14';
UPDATE tratamientos_completados SET total_original = 2900.00, total_descuento = 0.00, total_final = 2900.00, actualizado_en = NOW() WHERE id = 'a87ff8ee-64e3-4dce-b316-eee86ed74232';
UPDATE tratamientos_completados SET total_original = 4000.00, total_descuento = 0.00, total_final = 4000.00, actualizado_en = NOW() WHERE id = 'b4108e41-fc87-477f-94c3-43abfc3236f6';
UPDATE tratamientos_completados SET total_original = 5000.00, total_descuento = 0.00, total_final = 5000.00, actualizado_en = NOW() WHERE id = '861a1fae-e5d3-4d82-bfa2-7aa1d275d686';
UPDATE tratamientos_completados SET total_original = 5000.00, total_descuento = 0.00, total_final = 5000.00, actualizado_en = NOW() WHERE id = '4208de1a-f7d4-4cfa-bcd7-40b5b4bde01a';

-- Fix payment status for all treatments using currency conversion logic
UPDATE tratamientos_completados 
SET 
    monto_pagado = (
        SELECT COALESCE(SUM(monto_convertido), 0) 
        FROM payments 
        WHERE tratamiento_completado_id = tratamientos_completados.id
        AND monto_convertido IS NOT NULL
    ) + (
        SELECT COALESCE(SUM(monto_pago), 0) 
        FROM payments 
        WHERE tratamiento_completado_id = tratamientos_completados.id
        AND monto_convertido IS NULL
    ),
    estado_pago = CASE
        WHEN total_final = 0 THEN 'pagado'
        WHEN total_final <= (
            SELECT COALESCE(SUM(monto_convertido), 0) 
            FROM payments 
            WHERE tratamiento_completado_id = tratamientos_completados.id
            AND monto_convertido IS NOT NULL
        ) + (
            SELECT COALESCE(SUM(monto_pago), 0) 
            FROM payments 
            WHERE tratamiento_completado_id = tratamientos_completados.id
            AND monto_convertido IS NULL
        ) THEN 'pagado'
        WHEN (
            SELECT COALESCE(SUM(monto_convertido), 0) 
            FROM payments 
            WHERE tratamiento_completado_id = tratamientos_completados.id
            AND monto_convertido IS NOT NULL
        ) + (
            SELECT COALESCE(SUM(monto_pago), 0) 
            FROM payments 
            WHERE tratamiento_completado_id = tratamientos_completados.id
            AND monto_convertido IS NULL
        ) > 0 THEN 'parcialmente_pagado'
        ELSE 'pendiente'
    END,
    actualizado_en = NOW()
WHERE total_final > 0;

-- Show all updated treatments
SELECT id, paciente_id, fecha_cita, total_original, total_descuento, total_final, estado_pago, monto_pagado, saldo_pendiente 
FROM tratamientos_completados 
WHERE total_final > 0 
ORDER BY fecha_cita DESC;
